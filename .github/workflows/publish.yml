name: Publish NPM Packages

on:
  push:
    branches:
      - main
      - master

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Get OIDC ID token
        id: oidc
        shell: bash
        env:
          OIDC_AUDIENCE: ${{ vars.OIDC_AUDIENCE }}
        run: |
          AUD="${OIDC_AUDIENCE:-sts.amazonaws.com}"
          TOKEN_URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUD}"
          ID_TOKEN=$(curl -s -H "Authorization: bearer ${ACTIONS_RUNTIME_TOKEN}" "${TOKEN_URL}" | jq -r '.value')
          if [ -z "$ID_TOKEN" ] || [ "$ID_TOKEN" = "null" ]; then
            echo "Failed to retrieve OIDC ID token"
            exit 1
          fi
          echo "::add-mask::$ID_TOKEN"
          echo "id_token=$ID_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: npm install

      - name: Publish packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          #!/bin/bash
          # Find all package.json files recursively
          find . -name "package.json" -type f | while read -r package_file; do
            dir=$(dirname "$package_file")
            dir=${dir#./}
            dir=${dir%/}
            
            # Skip root package.json if present
            if [ "$dir" = "." ]; then
              continue
            fi
            
            # Check if package.json has a "name" field
            if jq -e '.name' "$package_file" > /dev/null 2>&1; then
              echo "Publishing package: $dir"
              (
                cd "$dir"
                npm publish
                if [ $? -eq 0 ]; then
                  echo "✓ Successfully published $dir"
                else
                  echo "✗ Failed to publish $dir"
                  exit 1
                fi
              )
              if [ $? -ne 0 ]; then
                exit 1
              fi
            else
              echo "Skipping $dir - no name field in package.json"
            fi
          done
