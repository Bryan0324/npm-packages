name: Publish NPM Packages

on:
  push:
    branches:
      - main
      - master

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    environment:
      name: ${{ vars.PUBLISH_ENV || 'publish' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm install

      - name: Publish packages
        run: |
          #!/bin/bash
          # Find all package.json files recursively
          find . -name "package.json" -type f | while read -r package_file; do
            dir=$(dirname "$package_file")
            dir=${dir#./}
            dir=${dir%/}
            
            # Skip root package.json if present
            if [ "$dir" = "." ]; then
              continue
            fi
            
            # Check if package.json has a "name" field
            if jq -e '.name' "$package_file" > /dev/null 2>&1; then
              echo "Publishing package: $dir"
              (
                cd "$dir"
                # Install with lockfile if available; fallback to install
                if [ -f package-lock.json ]; then
                  npm ci
                else
                  npm install
                fi

                name=$(jq -r '.name' package.json)
                ACCESS_ARG=""
                if [[ "$name" == @*/* ]]; then
                  ACCESS_ARG="--access public"
                fi

                # Ensure repository field points to this repo and subdirectory
                REPO_URL="git+https://github.com/Bryan0324/npm-packages.git"
                REPO_DIR="$dir"
                CUR_DIR=$(jq -r '.repository.directory // empty' package.json)
                CUR_URL=$(jq -r '.repository.url // empty' package.json)
                if [ "$CUR_DIR" != "$REPO_DIR" ] || [ "$CUR_URL" != "$REPO_URL" ]; then
                  tmpfile=$(mktemp)
                  jq --arg url "$REPO_URL" --arg d "$REPO_DIR" \
                    '.repository = {type:"git", url:$url, directory:$d}' package.json > "$tmpfile" && mv "$tmpfile" package.json
                  echo "Updated repository field: url=$REPO_URL directory=$REPO_DIR"
                else
                  echo "Repository field already set correctly"
                fi

                # Ensure we use OIDC (Trusted Publishers) rather than legacy tokens
                unset NODE_AUTH_TOKEN || true

                # Publish with error capture and diagnostics
                if npm publish --provenance $ACCESS_ARG 2>&1; then
                  echo "✓ Successfully published $dir"
                else
                  EXIT_CODE=$?
                  echo "✗ Failed to publish $dir (exit code: $EXIT_CODE)"
                  echo "Debug: npm whoami"
                  npm whoami 2>&1 || echo "  (Not authenticated)"
                  echo "Debug: package.json repository field:"
                  jq '.repository' package.json 2>&1
                fi
              )
            else
              echo "Skipping $dir - no name field in package.json"
            fi
          done
